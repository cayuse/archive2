class Api::V1::AuthController < ApplicationController
  skip_before_action :verify_authenticity_token
  before_action :authenticate_api_user!, only: [:verify, :logout]

  def login
    user = User.find_by(email: params[:email])
    
    if user&.authenticate(params[:password])
      # Generate API token
      api_token = generate_api_token(user)
      
      render json: {
        success: true,
        message: "Authentication successful",
        api_token: api_token,
        user: {
          id: user.id,
          name: user.name,
          email: user.email,
          role: user.role
        }
      }, status: :ok
    else
      render json: {
        success: false,
        message: "Invalid email or password"
      }, status: :unauthorized
    end
  end

  def logout
    # In a real implementation, you might want to invalidate the token
    # For now, we'll just return a success message
    render json: {
      success: true,
      message: "Logged out successfully"
    }, status: :ok
  end

  def verify
    # This endpoint is used to verify API tokens
    render json: {
      success: true,
      message: "API token is valid",
      user: {
        id: @current_api_user.id,
        name: @current_api_user.name,
        email: @current_api_user.email,
        role: @current_api_user.role
      }
    }, status: :ok
  end

  private

  def generate_api_token(user)
    # Create payload with user info and expiration
    payload = {
      user_id: user.id,
      email: user.email,
      role: user.role,
      exp: 30.days.from_now.to_i,
      iat: Time.current.to_i,
      iss: 'archive-api'
    }
    
    # Convert to JSON and encrypt with Rails master key
    json_payload = payload.to_json
    encrypted_token = Rails.application.encryptor.encrypt_and_sign(json_payload)
    
    # Base64 encode for URL safety
    Base64.urlsafe_encode64(encrypted_token)
  end

  def authenticate_api_user!
    token = extract_token_from_header
    
    if token.blank?
      render json: { success: false, message: "Missing API token" }, status: :unauthorized
      return
    end

    begin
      # Decode from Base64
      decoded_token = Base64.urlsafe_decode64(token)
      
      # Decrypt with Rails master key
      decrypted_payload = Rails.application.encryptor.decrypt_and_verify(decoded_token)
      
      # Parse JSON payload
      payload = JSON.parse(decrypted_payload)
      
      # Check if token is expired
      if payload['exp'] && Time.current.to_i > payload['exp']
        render json: { success: false, message: "API token expired" }, status: :unauthorized
        return
      end
      
      # Find the user
      @current_api_user = User.find(payload['user_id'])
      
      unless @current_api_user
        render json: { success: false, message: "Invalid API token" }, status: :unauthorized
        return
      end
      
    rescue => e
      Rails.logger.error "Token decryption error: #{e.message}"
      render json: { success: false, message: "Invalid API token" }, status: :unauthorized
      return
    end
  end

  def extract_token_from_header
    auth_header = request.headers['Authorization']
    return nil unless auth_header
    
    # Extract token from "Bearer <token>" format
    token = auth_header.gsub(/^Bearer\s+/, '')
    token.presence
  end
end 