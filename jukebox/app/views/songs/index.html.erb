<div class="container">
  <% device_type = cookies[:device_type] || 'desktop' # Default to desktop if cookie not set %>
  <div class="row">
    <div class="col-12">
      <!-- Notice Container -->
      <div id="notice-container"></div>
      
      <!-- Page Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Songs</h1>

      </div>
      
      <!-- Search Bar -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <input type="text" id="search-input" class="form-control" placeholder="Search songs, artists, albums, or genres..." autocomplete="off">
            </div>
            <div class="col-md-4">
              <button id="clear-search" class="btn btn-outline-secondary" style="display: none;">Clear Search</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Songs Table -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">All Songs</h5>
          <div class="d-flex align-items-center gap-3">
            <div id="song-count" class="theme-text-muted"></div>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover song-list-table">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Artist</th>
                  <th class="hide-on-narrow">Album</th>
                  <th class="hide-on-narrow">Genre</th>
                  <th class="hide-on-narrow">Duration</th>
                  
                  <th>Play</th>
                </tr>
              </thead>
              <tbody id="songs-table-body">
                <%= render partial: 'song_list', locals: { songs: @songs } %>
              </tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          <% if @songs.respond_to?(:current_page) %>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div class="text-muted">
                Showing <%= @songs.offset_value + 1 %> to <%= @songs.offset_value + @songs.length %> of <%= @songs.total_count %> songs
              </div>
              <div>
                <% if defined?(device_type) && device_type == 'mobile' %>
                    <%= link_to_next_page @songs, 'Next Page' %>
                <% else %>
                  <%= paginate @songs %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Set a cookie based on screen size
document.addEventListener('DOMContentLoaded', function() {
  const screenWidth = window.innerWidth;
  let deviceType;

  if (screenWidth < 768) {
  deviceType = 'mobile';
  } else if (screenWidth >= 768 && screenWidth < 1200) {
  deviceType = 'tablet';
  } else {
  deviceType = 'desktop';
  }

  document.cookie = `device_type=${deviceType}; path=/`;
});

// Ensure playlist functions are available immediately
// Notice system functions
window.showNotice = function(message, type = 'success') {
  const noticeContainer = document.getElementById('notice-container');
  if (!noticeContainer) return;
  
  const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
  const noticeHtml = `
    <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  `;
  
  noticeContainer.innerHTML = noticeHtml;
  
  // Auto-dismiss after 5 seconds
  setTimeout(() => {
    const alert = noticeContainer.querySelector('.alert');
    if (alert) {
      alert.remove();
    }
  }, 5000);
};



function initializeSearch() {
  console.log('Initializing search functionality');
  
  let searchTimeout;
  let currentlyPlaying = null;
  
  const searchInput = document.getElementById('search-input');
  const clearSearchBtn = document.getElementById('clear-search');
  const songsTableBody = document.getElementById('songs-table-body');
  const songCountDiv = document.getElementById('song-count');
  
  console.log('Search input element:', searchInput);
  console.log('Songs table body element:', songsTableBody);
  
  if (!searchInput) {
    console.error('Search input not found!');
    return;
  }
  
  if (!songsTableBody) {
    console.error('Songs table body not found!');
    return;
  }
  
  // Live search functionality
  searchInput.addEventListener('input', function() {
    console.log('Search input event triggered');
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(function() {
      const query = searchInput.value.trim();
      console.log('Searching for:', query);
      performSearch(query);
    }, 300); // Debounce search
  });
  
  // Clear search
  clearSearchBtn.addEventListener('click', function() {
    searchInput.value = '';
    performSearch('');
    clearSearchBtn.style.display = 'none';
  });
  
  function performSearch(query) {
    const params = new URLSearchParams({
      q: query,
      page: 1
    });
    
    console.log('Fetching from:', `/songs/search?${params}`);
    fetch(`/songs/search?${params}`)
      .then(response => response.text())
      .then(html => {
        songsTableBody.innerHTML = html;
        
        // Re-initialize audio players after loading new content
        initializeAudioPlayers();
        
        // Update song count
        const songCount = songsTableBody.querySelectorAll('tr').length;
        songCountDiv.textContent = `${songCount} songs`;
        
        // Show/hide clear search button
        if (query) {
          clearSearchBtn.style.display = 'block';
        }
        
        // Update URL to reflect search
        const url = new URL(window.location);
        if (query) {
          url.searchParams.set('q', query);
        } else {
          url.searchParams.delete('q');
        }
        url.searchParams.delete('page');
        window.history.replaceState({}, '', url);
      })
      .catch(error => {
        console.error('Error loading songs:', error);
      });
  }
  
  // Initialize song count
  const initialCount = songsTableBody.querySelectorAll('tr').length;
  songCountDiv.textContent = `${initialCount} songs`;
  
  // Audio Player Functionality
  function initializeAudioPlayers() {
    const playButtons = document.querySelectorAll('.play-btn');
    
    playButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        const audioId = this.getAttribute('data-audio-id');
        const songTitle = this.getAttribute('data-song-title');
        const audio = document.getElementById(`audio-${audioId}`);
        const timeSpan = document.getElementById(`time-${audioId}`);
        const icon = this.querySelector('i');
        
        if (!audio) {
          console.error('Audio element not found for ID:', audioId);
          return;
        }
        
        // Stop any currently playing audio
        if (currentlyPlaying && currentlyPlaying !== audio) {
          const currentButton = document.querySelector(`[data-audio-id="${currentlyPlaying.id.replace('audio-', '')}"]`);
          if (currentButton) {
            const currentIcon = currentButton.querySelector('i');
            currentIcon.className = 'fas fa-play';
            currentButton.classList.remove('btn-primary');
            currentButton.classList.add('btn-outline-primary');
          }
          currentlyPlaying.pause();
          currentlyPlaying.currentTime = 0;
        }
        
        if (audio.paused) {
          // Play the audio
          audio.play().then(() => {
            currentlyPlaying = audio;
            icon.className = 'fas fa-pause';
            this.classList.remove('btn-outline-primary');
            this.classList.add('btn-primary');
          }).catch(error => {
            console.error('Error playing audio:', error);
            showNotice('Error playing audio file: ' + error.message, 'danger');
          });
        } else {
          // Pause the audio
          audio.pause();
          icon.className = 'fas fa-play';
          this.classList.remove('btn-primary');
          this.classList.add('btn-outline-primary');
          currentlyPlaying = null;
        }
      });
    });
    
    // Add time update listeners for all audio elements
    const audioElements = document.querySelectorAll('audio');
    audioElements.forEach(audio => {
      audio.addEventListener('timeupdate', function() {
        const audioId = this.id.replace('audio-', '');
        const timeSpan = document.getElementById(`time-${audioId}`);
        const currentTime = Math.floor(this.currentTime);
        const duration = Math.floor(this.duration);
        
        if (!isNaN(duration)) {
          const currentMinutes = Math.floor(currentTime / 60);
          const currentSeconds = currentTime % 60;
          const totalMinutes = Math.floor(duration / 60);
          const totalSeconds = duration % 60;
          
          timeSpan.textContent = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')} / ${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
        }
      });
      
      audio.addEventListener('ended', function() {
        const audioId = this.id.replace('audio-', '');
        const button = document.querySelector(`[data-audio-id="${audioId}"]`);
        const icon = button.querySelector('i');
        icon.className = 'fas fa-play';
        button.classList.remove('btn-primary');
        button.classList.add('btn-outline-primary');
        currentlyPlaying = null;
        
        const timeSpan = document.getElementById(`time-${audioId}`);
        timeSpan.textContent = '--:--';
      });
      
      audio.addEventListener('loadedmetadata', function() {
        const audioId = this.id.replace('audio-', '');
        const timeSpan = document.getElementById(`time-${audioId}`);
        const duration = Math.floor(this.duration);
        
        if (!isNaN(duration)) {
          const minutes = Math.floor(duration / 60);
          const seconds = duration % 60;
          timeSpan.textContent = `0:00 / ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
      });
    });
  }
  
  // Initialize audio players when page loads
  initializeAudioPlayers();
}

// Initialize on both Turbo and regular page load
document.addEventListener('turbo:load', initializeSearch);
document.addEventListener('DOMContentLoaded', initializeSearch);


</script> 